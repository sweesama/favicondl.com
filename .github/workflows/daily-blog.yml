# ÊØèÊó•Ëá™Âä®ÁîüÊàêÂçöÂÆ¢ÊñáÁ´†
# 
# Â∑•‰ΩúÂéüÁêÜÔºö
# 1. ÊØèÂ§© UTC 00:00ÔºàÂåó‰∫¨Êó∂Èó¥ 08:00ÔºâËá™Âä®Ëß¶Âèë
# 2. ‰ªé queue.json Âèñ‰∏ã‰∏Ä‰∏™ÂÖ≥ÈîÆËØç
# 3. Ë∞ÉÁî® Gemini API ÁîüÊàê 5 ËØ≠Ë®ÄÊñáÁ´†Ôºàen/zh/ja/ko/esÔºâ
# 4. ÁîüÊàê HTML + Êõ¥Êñ∞ articles.json + sitemap.xml
# 5. ËøêË°å i18n build ÁîüÊàêÂ§öËØ≠Ë®ÄÈ°µÈù¢
# 6. Ëá™Âä® commit & push Âà∞ main ÂàÜÊîØ
#
# ÈúÄË¶ÅÂú® GitHub Repo ‚Üí Settings ‚Üí Secrets ‚Üí Actions ‰∏≠Ê∑ªÂä†:
#   GEMINI_API_KEY = ‰Ω†ÁöÑ Google AI Studio API Key

name: Daily Blog Article Generator

on:
  schedule:
    # ÊØèÂ§© UTC 00:00 ËøêË°åÔºàÂåó‰∫¨Êó∂Èó¥ 08:00Ôºâ
    - cron: '0 0 * * *'
  workflow_dispatch:
    # ‰πüÊîØÊåÅÊâãÂä®Ëß¶ÂèëÔºàÊñπ‰æøÊµãËØïÔºâ

permissions:
  contents: write

jobs:
  generate-article:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: blog/scripts
        run: npm install

      - name: Check if there are pending keywords
        id: check-queue
        run: |
          PENDING=$(node -e "
            const q = JSON.parse(require('fs').readFileSync('blog/queue.json','utf-8'));
            const p = q.filter(i => i.status === 'pending').length;
            console.log(p);
          ")
          echo "pending=$PENDING" >> $GITHUB_OUTPUT
          echo "üìã Pending keywords: $PENDING"

      - name: Generate article
        if: steps.check-queue.outputs.pending != '0'
        working-directory: blog/scripts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: node generate-article.js

      - name: Install i18n dependencies
        if: steps.check-queue.outputs.pending != '0'
        working-directory: i18n
        run: npm install

      - name: Build multi-language pages
        if: steps.check-queue.outputs.pending != '0'
        working-directory: i18n
        run: node build.js

      - name: Commit and push
        if: steps.check-queue.outputs.pending != '0'
        run: |
          git config user.name "Blog Bot"
          git config user.email "bot@favicondl.com"
          git add -A
          if ! git diff --staged --quiet; then
            SLUG=$(node -e "
              const q = JSON.parse(require('fs').readFileSync('blog/queue.json','utf-8'));
              const done = q.filter(i => i.status === 'done');
              console.log(done[done.length-1]?.slug || 'new-article');
            ")
            git commit -m "üìù Auto-publish blog: $SLUG"
            git pull --rebase origin main
            git push
          else
            echo "‚ÑπÔ∏è No file changes detected, skipping commit."
          fi

      - name: Summary
        if: steps.check-queue.outputs.pending != '0'
        run: echo "‚úÖ Article published successfully!"

      - name: No articles to publish
        if: steps.check-queue.outputs.pending == '0'
        run: echo "‚è∏Ô∏è No pending keywords in queue. Add more to blog/queue.json"
